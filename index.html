<script>
  // 1. Star animation (unchanged)
  function createStars() {
    const container = document.getElementById('starsContainer');
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = `${Math.random() * 100}%`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.width = `${Math.random() * 3 + 2}px`;
      star.style.height = star.style.width;
      star.style.setProperty('--duration', `${Math.random() * 5 + 3}s`);
      star.style.opacity = Math.random();
      container.appendChild(star);
    }
  }

  // 2. Generate random redemption code 
  function generateCode() {
    return 'TP-' + Math.random().toString(36).substr(2, 6).toUpperCase();
  }

  // 3. Handle successful payment
  async function handlePaymentSuccess(details, code, planType) {
    try {
      const response = await fetch('https://zodiiegithubio-production.up.railway.app/generate-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: details.payer.email_address,
          code: code,
          plan: planType,
          transaction_id: details.id
        })
      });

      if (!response.ok) throw new Error('Backend error');
      
      alert(`✅ Payment successful!\nYour code: ${code}\nRedeem in Discord: !redeem ${code}`);
    } catch (error) {
      console.error('Payment processing failed:', error);
      alert('⚠️ Payment processed but code generation failed. Contact support with your PayPal transaction ID.');
    }
  }

  // 4. PayPal Smart Buttons
  function setupPayPalButtons() {
    // Weekly Plan ($4.99)
    paypal.Buttons({
      style: {
        color: 'blue',
        shape: 'rect',
        label: 'pay'
      },
      createOrder: (data, actions) => {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: '4.99',
              currency_code: 'USD'
            },
            description: 'Weekly Premium Access'
          }]
        });
      },
      onApprove: (data, actions) => {
        return actions.order.capture().then(details => {
          const code = generateCode();
          handlePaymentSuccess(details, code, 'weekly');
        });
      },
      onError: (err) => {
        console.error('PayPal error:', err);
        alert('Payment failed. Please try again or contact support.');
      }
    }).render('#paypal-button-container-weekly');

    // Lifetime Plan ($9.99)
    paypal.Buttons({
      style: {
        color: 'gold',
        shape: 'pill',
        label: 'pay'
      },
      createOrder: (data, actions) => {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: '9.99',
              currency_code: 'USD'
            },
            description: 'Lifetime Premium Access'
          }]
        });
      },
      onApprove: (data, actions) => {
        return actions.order.capture().then(details => {
          const code = generateCode();
          handlePaymentSuccess(details, code, 'lifetime');
        });
      }
    }).render('#paypal-button-container-lifetime');
  }

  // 5. Initialize everything
  function init() {
    createStars();
    
    // Load PayPal SDK with YOUR SANDBOX ID
    const script = document.createElement('script');
    script.src = 'https://www.paypal.com/sdk/js?client-id=MTY9VCDR7FVQS&currency=USD';
    script.onload = setupPayPalButtons;
    script.onerror = () => alert('Failed to load PayPal. Check your connection.');
    document.head.appendChild(script);
  }

  // Start the app
  init();
</script>
